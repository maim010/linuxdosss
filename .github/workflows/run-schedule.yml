# ================================================================================
# Linux.do 自动浏览定时任务
# ================================================================================
#
# 功能：
#   - 定时自动运行浏览脚本
#   - 支持手动触发
#   - 自动登录并浏览帖子
#
# ================================================================================
# 使用说明
# ================================================================================
#
# 1. Fork 本仓库到你的账号
#
# 2. 将仓库设为私有（重要！保护你的账号信息）
#    Settings -> General -> Danger Zone -> Change visibility -> Make private
#
# 3. 添加 Secrets（Settings -> Secrets and variables -> Actions -> New repository secret）
#    - LINUXDO_USERNAME: 你的 Linux.do 用户名
#    - LINUXDO_PASSWORD: 你的 Linux.do 密码
#
# 4. 启用 Actions
#    Actions -> I understand my workflows, go ahead and enable them
#
# 5. 定时任务会自动运行，也可以手动触发
#    Actions -> Run Schedule -> Run workflow
#
# ================================================================================
# 定时规则说明
# ================================================================================
#
# cron 格式: 分 时 日 月 周
#
# 示例：
#   '0 0 * * *'   - 每天 UTC 0:00（北京时间 8:00）
#   '0 8 * * *'   - 每天 UTC 8:00（北京时间 16:00）
#   '0 0,12 * * *' - 每天 UTC 0:00 和 12:00（北京时间 8:00 和 20:00）
#   '0 0 * * 1-5' - 工作日 UTC 0:00（北京时间 8:00）
#
# 注意：GitHub Actions 使用 UTC 时间，北京时间 = UTC + 8
#
# ================================================================================

name: Run Schedule

on:
  # 定时触发（默认每天北京时间 8:00 和 20:00 各运行一次）
  schedule:
    - cron: '0 0 * * *'   # UTC 0:00 = 北京时间 8:00
    - cron: '0 12 * * *'  # UTC 12:00 = 北京时间 20:00

  # 手动触发
  workflow_dispatch:
    inputs:
      topics:
        description: '浏览帖子数量'
        required: false
        default: '2000'
      like_rate:
        description: '点赞概率 (0-100)'
        required: false
        default: '30'

jobs:
  browse:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # 最长运行1小时

    steps:
      # 检出代码
      - name: Checkout
        uses: actions/checkout@v4

      # 设置 Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 安装依赖
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install DrissionPage

      # 安装 Chrome
      - name: Install Chrome
        run: |
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      # 运行脚本
      - name: Run browse script
        env:
          LINUXDO_USERNAME: ${{ secrets.LINUXDO_USERNAME }}
          LINUXDO_PASSWORD: ${{ secrets.LINUXDO_PASSWORD }}
        run: |
          # 获取参数（手动触发时使用输入值，定时触发时使用默认值）
          TOPICS="${{ github.event.inputs.topics || '30' }}"
          LIKE_RATE="${{ github.event.inputs.like_rate || '30' }}"
          
          echo "========================================"
          echo "开始运行 Linux.do 自动浏览"
          echo "目标帖子数: $TOPICS"
          echo "点赞概率: $LIKE_RATE%"
          echo "========================================"
          
          python linux_do_headless.py \
            --topics "$TOPICS" \
            --like-rate "$LIKE_RATE" \
            --debug

      # 输出结果
      - name: Summary
        if: always()
        run: |
          echo "## 运行结果" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- 触发方式: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- 运行时间: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- 北京时间: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
